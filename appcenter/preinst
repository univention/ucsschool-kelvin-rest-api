#!/usr/bin/env bash

# Copyright (C) 2020-2025 Univention GmbH <http://www.univention.de/>
#
# All rights reserved.
#
# The source code of this program is made available
# under the terms of the GNU Affero General Public License version 3
# (GNU AGPL V3) as published by the Free Software Foundation.
#
# Binary versions of this program provided by Univention to you as
# well as other copyrighted, protected or trademarked materials like
# Logos, graphics, fonts, specific documentations and configurations,
# cryptographic keys etc. are subject to a license agreement between
# you and Univention and not subject to the GNU AGPL V3.
#
# In the case you use this program under the terms of the GNU AGPL V3,
# the program is provided in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public
# License with the Debian GNU/Linux or Univention distribution in file
# /usr/share/common-licenses/AGPL-3; if not, see
# <http://www.gnu.org/licenses/>.

#
# Script that runs in docker host before installing the app.
#

KELVIN_IMPORTUSER_HOOKS_PATH="/var/lib/ucs-school-import/kelvin-hooks"
KELVIN_SCHOOL_LIB_HOOKS_PATH="/var/lib/ucs-school-lib/kelvin-hooks"
KELVIN_CONFIG_PATH="/etc/ucsschool/kelvin"

################################################################################
# Helper and setup functions (kept free of side effects on source)
################################################################################

# set_kelvin_docker_env_trusted_proxy_ips
#
# Ensures that the UCR variable
#   appcenter/apps/ucsschool-kelvin-rest-api/docker/params
# contains an environment option of the form:
#   --env TRUSTED_PROXY_IPS=<IP>
#
# <IP> is the Docker host’s gateway address as seen from inside the
# kelvin-api container. This is the address where the reverse proxy for
# Kelvin is running, which in UCS deployments is the UCS node itself
# (i.e., the Docker host). The value is derived from the UCR variable:
#   docker/daemon/default/opts/bip
#
# This function is idempotent: if TRUSTED_PROXY_IPS is already present,
# nothing is changed. Otherwise the parameter fragment is created or appended.
#
# Returns:
#   0 on success; non-zero only if the underlying "ucr set" command fails.
set_kelvin_docker_env_trusted_proxy_ips() {
    local UCR_PARAM_KEY="appcenter/apps/ucsschool-kelvin-rest-api/docker/params"
    local UCR_DOCKER_BIP_KEY="docker/daemon/default/opts/bip"

    # Extract the host gateway IP from a Docker bip value ("IP/mask").
    docker_host_gateway_from_bip() {
        local bip="$1"
        printf "%s\n" "${bip%/*}"
    }

    local current_params
    current_params="$(ucr get "$UCR_PARAM_KEY" 2>/dev/null || true)"

    local bip_value
    bip_value="$(ucr get "$UCR_DOCKER_BIP_KEY")"

    local docker_host_ip
    docker_host_ip="$(docker_host_gateway_from_bip "$bip_value")"

    local trusted_proxy_env="--env TRUSTED_PROXY_IPS=${docker_host_ip}"

    # Already present → do nothing
    if [[ "$current_params" == *"TRUSTED_PROXY_IPS"* ]]; then
        echo "Verified: UCR var $UCR_PARAM_KEY already contains TRUSTED_PROXY_IPS"
        return 0
    fi

    # Missing or empty → set new
    if [[ -z "$current_params" ]]; then
        echo "Setting UCR var $UCR_PARAM_KEY=\"${trusted_proxy_env}\""
        ucr set "$UCR_PARAM_KEY=${trusted_proxy_env}"
        return 0
    fi

    # Otherwise append
    echo "Appending UCR var $UCR_PARAM_KEY+=\"${trusted_proxy_env}\""
    ucr set "$UCR_PARAM_KEY=${current_params} ${trusted_proxy_env}"
}

################################################################################
# Main logic wrapped in a function to keep sourcing side-effect free
################################################################################
main() {
    while [ $# -gt 0 ]; do
        case "$1" in
            "--error-file")
                shift
                errorfile="$1"
                shift
                ;;
            "--old-version")
                shift
                old_version="$1"
                shift
                ;;
            *)
                shift
                ;;
        esac
    done

    udm_output="$(udm users/user)"
    echo "$udm_output" | grep -q "ucsschoolStudent"
    if [ "$?" -ne 0 ]
    then
      message="The application 'UCS@school Kelvin REST API' requires the core 'UCS@school' application to be installed."
      echo "$message" > "$errorfile"
      exit 1
    fi

    if ! [ -e "$KELVIN_IMPORTUSER_HOOKS_PATH" ]; then
        mkdir -pv -m 755 "$KELVIN_IMPORTUSER_HOOKS_PATH"
    fi
    if ! [ -e "$KELVIN_SCHOOL_LIB_HOOKS_PATH" ]; then
        mkdir -pv -m 755 "$KELVIN_SCHOOL_LIB_HOOKS_PATH"
    fi
    if ! [ -e "$KELVIN_CONFIG_PATH" ]; then
        mkdir -pv -m 755 "$KELVIN_CONFIG_PATH"
        echo "{}" > "$KELVIN_CONFIG_PATH/mapped_udm_properties.json"
    fi

    set_kelvin_docker_env_trusted_proxy_ips

    # restart UDM REST API to ensure the OpenAPI schema is up to date
    service univention-directory-manager-rest restart

    if [ -n "$old_version" ] && [ "${old_version::2}" = "1." ]; then
        # Restart needed in case we just updated from 5.0 to 5.2
        univention-app restart ucsschool-kelvin-rest-api
    fi

    # Bug 58934
    source /usr/share/univention-lib/ucr.sh
    if ! is_ucr_true "ucsschool/kelvin/accept-custom-log-driver"; then
        logging_driver=$(docker info --format '{{.LoggingDriver}}')
        if [ "$logging_driver" != "journald" ]; then
            systemctl restart docker
            logging_driver=$(docker info --format '{{.LoggingDriver}}')
            if [ "$logging_driver" != "journald" ]; then
                echo "The Docker logging driver 'journald' is expected to be active, but the current logging driver is '$logging_driver'."
                echo "You can disable this check by setting the UCR variable 'ucsschool/kelvin/accept-custom-log-driver' to 'true'."
                echo "Aborting installation/upgrade."
                return 1
            fi
        fi
    fi
}

# Only run main when executed directly, not when sourced (e.g., by tests)
if [[ "${BASH_SOURCE[0]}" == "$0" ]]; then
    main "$@"
fi
