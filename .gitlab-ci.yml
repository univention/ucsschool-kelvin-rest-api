include:
  - project: 'univention/documentation/sphinx-docker'
    file: 'pipeline/sphinx.yml'
  - project: 'univention/dist/docker-services'
    file: 'kaniko.yml'


stages:
  - prepare
  - build
  - merge
  - production

variables:
  DOCS_DIR: "doc/docs"
  DOC_TARGET_NAME: "ucsschool-kelvin-rest-api"
  DOC_TARGET_PATH: $DOC_TARGET_NAME

prepare:
  stage: prepare
  image:
    name: python:3.9-bullseye
  artifacts:
    paths:
    - docker/build/
    expire_in: 1 day
  script:
    - apt-get update
    - apt-get install git rsync
    - cd ${CI_PROJECT_DIR}/docker
    - ./gitlab_prepare_docker_image

html:
  extends: .sphinx-html-template
  rules:
    - changes:
      - $DOCS_DIR/**/*

pdf:
  extends: .sphinx-pdf-template
  rules:
    - changes:
      - $DOCS_DIR/**/*

linkcheck:
  extends: .sphinx-linkcheck-template
  rules:
    - changes:
      - $DOCS_DIR/**/*

spelling:
  extends: .sphinx-spelling-template
  rules:
    - changes:
      - $DOCS_DIR/**/*

docs-merge:
  extends: .sphinx-merge-template
  needs:
    - job: html
      artifacts: true
    - job: pdf
      artifacts: true
    - job: spelling
      artifacts: false
    - job: linkcheck
      artifacts: false
  rules:
    - changes:
      - $DOCS_DIR/**/*

docs-production:
  stage: production
  cache:
    key: docs-$CI_COMMIT_REF_SLUG
    paths:
      - univention-docs
  interruptible: false
  variables:
    GIT_STRATEGY: none
    GIT_AUTHOR_NAME: $GITLAB_USER_NAME
    GIT_AUTHOR_EMAIL: $GITLAB_USER_EMAIL
    GIT_COMMITTER_NAME: $GITLAB_USER_NAME
    GIT_COMMITTER_EMAIL: $GITLAB_USER_EMAIL
  needs:
    - job: docs-merge
      artifacts: true
  resource_group: prod
  image: docker-registry.knut.univention.de/knut/git-sync
  rules:
    - changes:
      - $DOCS_DIR/**/*
      if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
      when: manual
  script:
    - git config --global credential.$CI_SERVER_URL.username ucs-docs-deployment
    - git config --global credential.$CI_SERVER_URL.helper '!f() { [ "$1" = get ] && echo password="$DOCS_TOKEN"; }; f'
    - '[ -d univention-docs ] || git clone --branch master --depth 1 --single-branch $CI_SERVER_URL/univention/docs.univention.de.git univention-docs'
    - cd univention-docs
    - git clean --force -d
    - git fetch --no-tags origin
    - git reset --hard origin/master
    - rsync -av --delete "$CI_PROJECT_DIR"/out/ ./"$DOC_TARGET_NAME"/
    - git add -- .
    - git commit -m "Automatic doc deployment from $CI_PROJECT_PATH by GitLab commit $CI_COMMIT_SHA"
    - git push
  environment:
    name: production
    url: http://updates.knut.univention.de/download/docs/$DOC_TARGET_NAME

build:
  stage: build
  dependencies:
    - prepare
  variables:
    KANIKO_BUILD_CONTEXT: docker/build/
  extends: .kaniko
