include:
  - project: 'univention/documentation/sphinx-docker'
    file: 'pipeline/sphinx.yml'
  - project: univention/dist/docker-services
    file:
    - kaniko.yml
    - pre-commit.yml

workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" && $CI_OPEN_MERGE_REQUESTS
    - if: $CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_REF_PROTECTED == "true"
    - if: $CI_PIPELINE_SOURCE == "web"
    - if: $CI_PIPELINE_SOURCE == "webide"


stages:
  - prepare
  - lint
  - build
  - tests
  - merge
  - production

variables:
  DOCS_DIR: "doc/docs"
  APP_ID: "ucsschool-kelvin-rest-api"
  PACKAGE: "ucs-test-ucsschool-kelvin"
  UCS_VERSION: "503"
  UCS_RELEASE: "5.0"
  SCOPE: "ucs-school-5.0"
  DOC_TARGET_NAME: $APP_ID
  DOC_TARGET_PATH: $DOC_TARGET_NAME
  DEB_IMAGE: docker-registry.knut.univention.de/phahn/ucs-debbase:$UCS_VERSION
  UCSLINT_IMAGE: gitregistry.knut.univention.de/univention/ucs


# This would use an image with the same name as the one
# used in build_docker_image. IMAGE_TAG can only be set once and
# can not be reset. The image has to be built manually until then.!reference:
# todo: fix this
#build_pre_commit:
#  stage: prepare
#  rules:
#    - changes:
#      - .gitlab-ci/Dockerfile.pre-commit
#      - .bandit
#      - .black
#      - .dockerignore
#      - .flake8
#      - .isort.cfg
#      - .pre-commit-config.yaml
#  extends: .kaniko
#  variables:
#    DOCKERFILE_PATH: .gitlab-ci/Dockerfile.pre-commit
#    KANIKO_ARGS: --cache=true

run_pre_commit:
  stage: lint
  extends: .pre-commit
  variables:
    PRE_COMMIT_IMAGE: "docker-registry.knut.univention.de/knut/pre-commit-opa-python3.8"


prepare:
  stage: prepare
  rules:
    - changes:
        - docker/*
        - kelvin-api/**/*
        - ucs-school-import/**/*
        - ucs-school-lib/**/*
        - univention-directory-manager-modules-slim/**/*
        - univention-lib-slim/**/*
  image:
    name: python:3.9-bullseye
  artifacts:
    paths:
    - docker/build/
    expire_in: 1 day
  cache:
    - key: "$CI_COMMIT_REF_SLUG"
      paths:
        - docker/build/
  script:
    - apt-get update
    - apt-get install -y git rsync
    - cd ${CI_PROJECT_DIR}/docker
    - ./gitlab_prepare_docker_image


html:
  extends: .sphinx-html-template
  rules:
    - changes:
      - $DOCS_DIR/**/*

pdf:
  extends: .sphinx-pdf-template
  rules:
    - changes:
      - $DOCS_DIR/**/*

linkcheck:
  extends: .sphinx-linkcheck-template
  rules:
    - changes:
      - $DOCS_DIR/**/*

spelling:
  extends: .sphinx-spelling-template
  rules:
    - changes:
      - $DOCS_DIR/**/*

docs-merge:
  extends: .sphinx-merge-template
  needs:
    - job: html
      artifacts: true
    - job: pdf
      artifacts: true
    - job: spelling
      artifacts: false
    - job: linkcheck
      artifacts: false
  rules:
    - changes:
      - $DOCS_DIR/**/*

docs-production:
  stage: production
  cache:
    key: docs-$CI_COMMIT_REF_SLUG
    paths:
      - univention-docs
  interruptible: false
  variables:
    GIT_STRATEGY: none
    GIT_AUTHOR_NAME: $GITLAB_USER_NAME
    GIT_AUTHOR_EMAIL: $GITLAB_USER_EMAIL
    GIT_COMMITTER_NAME: $GITLAB_USER_NAME
    GIT_COMMITTER_EMAIL: $GITLAB_USER_EMAIL
  needs:
    - job: docs-merge
      artifacts: true
  resource_group: prod
  image: docker-registry.knut.univention.de/knut/git-sync
  rules:
    - changes:
      - $DOCS_DIR/**/*
      if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
      when: manual
  script:
    - git config --global credential.$CI_SERVER_URL.username ucs-docs-deployment
    - git config --global credential.$CI_SERVER_URL.helper '!f() { [ "$1" = get ] && echo password="$DOCS_TOKEN"; }; f'
    - '[ -d univention-docs ] || git clone --branch master --depth 1 --single-branch $CI_SERVER_URL/univention/docs.univention.de.git univention-docs'
    - cd univention-docs
    - git clean --force -d
    - git fetch --no-tags origin
    - git reset --hard origin/master
    - rsync -av --delete "$CI_PROJECT_DIR"/out/"$DOC_TARGET_NAME"/ ./"$DOC_TARGET_NAME"/
    - git add -- .
    - git commit -m "Automatic doc deployment from $CI_PROJECT_PATH by GitLab commit $CI_COMMIT_SHA"
    - git push
  environment:
    name: production
    url: http://updates.knut.univention.de/download/docs/$DOC_TARGET_NAME


build_docker_image:
  stage: build
  rules:
    - changes:
        - docker/*
        - kelvin-api/**/*
        - ucs-school-import/**/*
        - ucs-school-lib/**/*
        - univention-directory-manager-modules-slim/**/*
        - univention-lib-slim/**/*
  extends: .kaniko
  variables:
      KANIKO_BUILD_CONTEXT: "$CI_PROJECT_DIR/docker/build/"
      KANIKO_ARGS: --build-arg app_id="$APP_ID" --build-arg commit="$CI_COMMIT_SHA" --build-arg date="$CI_JOB_STARTED_AT" --cache=true --cache-repo $CI_REGISTRY_IMAGE/cache --cache-copy-layers

tests:
  stage: tests
  rules:
    - changes:
        - kelvin-api/**/*
        - ucs-school-lib/**/*
  needs:
    - job: build_docker_image
  image: $IMAGE_TAG
  script:
    - cd ${CI_PROJECT_DIR}/kelvin-api && make test
    - cd ${CI_PROJECT_DIR}/ucs-school-lib/modules/ucsschool/lib && pytest -v tests

ucs_test_deb_lint:
  stage: lint
  rules:
    - changes:
      - ucs-test-ucsschool-kelvin/**/*
  image:
    name: $UCSLINT_IMAGE
    entrypoint: [""]
  script:
    - cd ucs-test-ucsschool-kelvin && ucslint -j ucslint.xml
  artifacts:
    reports:
      junit: ucs-test-ucsschool-kelvin/ucslint.xml

ucs_test_deb_build_git:
  stage: build
  image: $DEB_IMAGE
  rules:
    - if: $CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH
      changes:
        - ucs-test-ucsschool-kelvin/**/*
  script:
    - apt-get update
    - cd ucs-test-ucsschool-kelvin
    - apt-get -q --assume-yes build-dep .
    - dpkg-buildpackage -us -uc
    - install -d -m 755 build
    - mv ../*.tar.*z ../*.dsc ../*.deb ../*.buildinfo ../*.changes build/
  artifacts:
    paths:
      - ucs-test-ucsschool-kelvin/build/

ucs_test_deb_repo_import:
  stage: build
  variables:
    GIT_STRATEGY: none
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        - ucs-test-ucsschool-kelvin/debian/changelog
  tags:
    - omar
  script:
    - >
      repo_admin.py
      -G $CI_REPOSITORY_URL
      -b $CI_COMMIT_BRANCH
      -P ucs-test-ucsschool-kelvin
      -r ${UCS_RELEASE}-0-0
      -s $SCOPE
      -p $PACKAGE

ucs_test_deb_repo_build:
  stage: build
  needs:
    - job: ucs_test_deb_repo_import
      artifacts: false
  variables:
    GIT_STRATEGY: none
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        - ucs-test-ucsschool-kelvin/debian/changelog
  tags:
    - ladda
  script:
    - >
      build-package-ng
      --no-pbuilder-update
      -r ${UCS_RELEASE}-0-0
      -s $SCOPE
      -p $PACKAGE
